<!DOCTYPE html>
<html>

<head>
    <script src="http://code.jquery.com/jquery-1.3.2.js"></script>
    <script src="JS/notification.js"></script>
    <script src="JS/IPC.js"></script>
    <script src="JS/saveloadSystem.js"></script>

    <link rel="stylesheet" href="CSS/navbar.css">
    <style>
        body {
            height: 100%;
            overflow-y: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .iframe-container {
            flex: 1;
            height: 100%;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }

        .split {
            height: 100%;
            width: 0.25vh;
            right: 50%;
            background-color: black;
            position: fixed;

        }

        #notification {
            position: absolute;
            top: -10vh;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            border: solid 0.25vh black;
            color: #000;
            padding: 1vh 5vh;
            z-index: 1;
        }
    </style>
    <script>
        $(document).ready(function () {
            $(".iframe-container").scroll(function () {
                var scrollTop = $(this).scrollTop();
                var scrollLeft = $(this).scrollLeft();
                $(".iframe-container").not(this).scrollTop(scrollTop).scrollLeft(scrollLeft);
            });
        });
    </script>
</head>



<body>

    <div id="notification">This is a notification</div>

    <button class="openbtn" onclick="toggleNav()">↳</button>


    <div id="mySidenav" class="sidenav">
        <button class="tButton" id="fpButton" onclick="PageToggle()">full page</button>
        <button class="tButton" id="mpButton" onclick="MultiplePage()">multi page</button>
        <button class="tButton" onclick="resetZoom()">Reset Zoom</button>
    </div>


    <div class="container">
        <div class="iframe-container" id="pdf_iframe">
            <iframe src="PDF.html" id="pdfViewer"></iframe>
        </div>
        <div class="split"></div>
        <div class="iframe-container" id="board_iframe">
            <iframe src="Board.html" id="Board_Viewer"></iframe>
        </div>
    </div>


</body>




<script>
    var view_mode = "0";
    let zoomValue = 1;
    var { ipcRenderer } = require('electron');


    /*
    window.onresize = function () {
        resetZoom();
    };
    */
    function onViewModeZero() {
        let board = document.getElementById("board_iframe");
        board.style.display = "block"
    }

    function onViewModeOne() {
        let board = document.getElementById("board_iframe");
        board.style.display = "none"
    }
    // Create a proxy to intercept changes to view_mode
    var view_mode_proxy = new Proxy({
        value: view_mode
    }, {
        set: function (target, key, value) {
            if (key === 'value') {
                if (value === "0") {
                    onViewModeZero();
                } else if (value === "1") {
                    onViewModeOne();
                } else {
                    console.error("Invalid view mode: " + value);
                    return false; // Prevent setting invalid values
                }
                target[key] = value;
                return true;
            }
        }
    });



    function GetIframeHeight(ID) {
        var iframe = document.getElementById(ID);
        var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
        var iframeHeight = iframeDocument.getElementById('viewerContainer').scrollHeight;
        return iframeHeight;
    }

    function setIframeBodyHeight(iframeId, height) {
        var iframe = document.getElementById(iframeId);
        if (iframe) {
            var iframeDocument = iframe.contentDocument || iframe.contentWindow.document;
            iframeDocument.body.style.height = height + 'px';
            localStorage.setItem("board_height", iframeDocument.body.scrollHeight);
            localStorage.setItem("board_width", iframeDocument.body.scrollWidth);
        } else {
            console.error('Iframe with id', iframeId, 'not found.');
        }
    }

    var PDF_Iframe = document.getElementById('pdfViewer');
    var Board_Iframe = document.getElementById('Board_Viewer');
    let temp_zoom = 1;

    function changeZoom(value) {
        if (view_mode_proxy.value == 1) {
            showNotification_value("zoom: " + value.toFixed(3));
            zoomValue = value;
            var viewerContainer = PDF_Iframe.contentDocument.getElementById('viewerContainer');
            viewerContainer.setAttribute('zoom', value);
            temp_zoom = value;
        }
    }

    PDF_Iframe.addEventListener('load', function () {
        var viewerContainer = PDF_Iframe.contentDocument.getElementById('viewerContainer');
        viewerContainer.addEventListener('wheel', function (event) {
            if (event.ctrlKey) {
                event.preventDefault();
                var delta = Math.sign(event.deltaY);

                var zoomStep = 0.05; // You can adjust this value for finer or coarser zoom increments
                var newZoom = zoomValue + delta * zoomStep;
                newZoom = Math.max(0.1, Math.min(10.0, newZoom));

                changeZoom(newZoom);
            }
        });
    });


    function resetZoom() {
        showNotification_value("zoom: page-width");
        var viewerContainer = PDF_Iframe.contentDocument.getElementById('viewerContainer');
        var currentZoom = parseFloat(viewerContainer.getAttribute('zoom'));
        viewerContainer.setAttribute('zoom', "page-width");
        temp_zoom = "page-width";
        let pdf_width = viewerContainer.scrollWidth;
        localStorage.setItem("pdf_width", pdf_width);
    }

    function PageToggle() {
        var viewerContainer = PDF_Iframe.contentDocument.getElementById('viewerContainer');
        var currentZoom = parseFloat(viewerContainer.getAttribute('zoom'));
        let split = document.getElementsByClassName("split")[0];
        let button = document.getElementById('fpButton');
        button.classList.toggle('tButton_activated');
        button.classList.toggle('tButton');


        if (view_mode_proxy.value == 0) {
            showNotification_value("page layout: text only");
            split.style.display = "none";
            view_mode_proxy.value = "1"
            viewerContainer.setAttribute('zoom', temp_zoom);
        } else if (view_mode_proxy.value == 1) {
            showNotification_value("page layout: text & board");
            split.style.display = "block";
            view_mode_proxy.value = "0";
            viewerContainer.setAttribute('zoom', "page-width");
        }
    }

    function MultiplePage() {
        var viewer = PDF_Iframe.contentDocument.getElementById('viewer');
        let button = document.getElementById('mpButton');
        button.classList.toggle('tButton_activated');
        button.classList.toggle('tButton');

        viewer.classList.toggle('pdfViewer');
        viewer.classList.toggle('pdfViewer_MultiplePage');
        if (view_mode_proxy.value == 0) {
            showNotification("Multiple Page Mode is only available in Full Page Mode", 1.5);
        }
    }
    let board_test = false
    setTimeout(function () {
        if (board_test == false) {
            //setIframeBodyHeight('Board_Viewer', GetIframeHeight('pdfViewer'));
            //setIframeBodyHeight('Board_Viewer', localStorage.getItem("total_height"));
        }
        if (board_test == true) {
            let boardIF = document.getElementById('Board_Viewer');
            let doc = boardIF.contentDocument || boardIF.contentWindow.document;
            doc.body.style.height = '1000px';
            if (document.getElementById('pdfViewer')) {
                document.getElementById('pdf_iframe').style.display = "none";
            }
        }
    }, 300);


    // Debounce function to limit scroll event firing frequency
    function debounce(func, delay) {
        let timeoutId;
        return function (...args) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                func.apply(this, args);
            }, delay);
        };
    }

    // Function to synchronize scrolling between PDF and Board
    function syncScroll(fromElement, toElement) {
        const scrollTop = fromElement.scrollTop;
        toElement.contentWindow.scrollTo(0, scrollTop);
    }

    function syncScroll_Second(value) {
        var PDF_Iframe = document.getElementById('pdfViewer');
        var PDF_iframeDocument = PDF_Iframe.contentDocument || PDF_Iframe.contentWindow.document;
        var PDF_DIV = PDF_iframeDocument.getElementById('viewerContainer');
        PDF_DIV.scrollTo(0, value);
    }


    let activeIframe = null;

    function setActiveIframe(iframe) {
        activeIframe = iframe;
    }

    // PDF Viewer
    PDF_Iframe.addEventListener("load", function () {
        setActiveIframe('PDF');
        const PDF_iframeDocument = PDF_Iframe.contentDocument || PDF_Iframe.contentWindow.document;
        const PDF_DIV = PDF_iframeDocument.getElementById('viewerContainer');
        let lastScrollTop = PDF_DIV.scrollTop;
        // Synchronize PDF scroll to Board
        PDF_DIV.addEventListener('scroll', debounce(() => {
            const scrollTop = PDF_DIV.scrollTop;
            if (scrollTop !== lastScrollTop) {
                lastScrollTop = scrollTop;
                if (activeIframe === 'PDF') {
                    syncScroll(PDF_DIV, document.getElementById('Board_Viewer'));
                }
            }
        }, 1));
    });

    // Board Viewer
    Board_Iframe.addEventListener("load", function () {
        setActiveIframe('Board');
        const iframeWindow = Board_Iframe.contentWindow;
        const iframeDocument = iframeWindow.document;
        let lastScrollTop = iframeDocument.documentElement.scrollTop || iframeDocument.body.scrollTop;

        // Synchronize Board scroll to PDF
        iframeDocument.addEventListener('scroll', debounce(() => {
            lastScrollTop = iframeDocument.documentElement.scrollTop || iframeDocument.body
                .scrollTop;
            if (activeIframe === 'Board') {
                syncScroll_Second(lastScrollTop);
            }
        }, 1));
    });

    // Event listeners to track active iframe
    PDF_Iframe.addEventListener('mouseover', function () {
        setActiveIframe('PDF');
    });

    Board_Iframe.addEventListener('mouseover', function () {
        setActiveIframe('Board');
    });

    function toggleNav() {
        let button = document.getElementsByClassName("openbtn")[0];
        let sidenav = document.getElementById("mySidenav");
        if (sidenav.style.width === "6vh") {
            button.innerHTML = "↳";
            sidenav.style.width = "0";
            sidenav.style.border = "solid 0vh black"
            sidenav.style.borderTop = "none";
        } else {
            button.innerHTML = "↲";
            sidenav.style.width = "6vh";
            sidenav.style.border = "solid 0.25vh black"
            sidenav.style.borderTop = "none";
        }
    }
    
    function restart() {
        ipcRenderer.send('restart');
    }

    ipcRenderer.send('AI', "HI how are you?");
    ipcRenderer.on('AIResponse', (event, file) => {
        showNotification(file, 2);
        });

</script>

</html>